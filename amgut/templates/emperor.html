{% extends sitebase.html%}
{% block head%}
<link rel="stylesheet" type="text/css" href="/static/emperor/support_files/css/emperor.css">
<link rel="stylesheet" type="text/css" href="/static/emperor/support_files/vendor/css/jquery-ui.min.css">
<link rel="stylesheet" type="text/css" href="/static/emperor/support_files/vendor/css/slick.grid.min.css">
<link rel="stylesheet" type="text/css" href="/static/emperor/support_files/vendor/css/spectrum.min.css">
<link rel="stylesheet" type="text/css" href="/static/emperor/support_files/vendor/css/chosen.min.css">

<style>
  div.emperor-space{
    height: 600px;
    width: 100%%;
    margin: 0;
  }
</style>
<script src="/static/vendor/js/chroma.min.js"></script>
<script src="/static/vendor/js/Chart.bundle.min.js"></script>
<script type="text/javascript" src="/static/emperor/support_files/vendor/js/require-2.1.22.min.js"></script>
<script src="/static/js/interactive.js"></script>
<script type="text/javascript">
  var barChartSummaryData = {
    labels: {% raw [b['barcode'] + ' - ' + t for b, t in zip(barcodes, titles) ] %},
    rawLabels: {% raw [b['barcode'] + ' - ' + t for b, t in zip(barcodes, titles) ] %},
    datasets: [],
    rawData: {% raw datasets %},
    metaData: {% raw datasets %}
  };
  var barChartFoldData = {
    labels: [],
    datasets: [],
    barcodes: {% raw [b['barcode'] for b in barcodes] %},
    titles: {% raw titles %}
  };

  var ec;

  function change_meta_cat(meta_cat) {
    ec.colorController.$select.val(meta_cat);
    ec.colorController.$select.trigger("change");
  }

  requirejs.config({
    'baseUrl': '/static/emperor/support_files/',

    // the left side is the module name, and the right side is the path
    // relative to the baseUrl attribute, do NOT include the .js extension
    'paths': {
      /* jQuery */
      'jquery': './vendor/js/jquery-2.1.4.min',
      'jqueryui': './vendor/js/jquery-ui.min',
      'jquery_drag': './vendor/js/jquery.event.drag-2.2.min',

      /* jQuery plugins */
      'chosen': './vendor/js/chosen.jquery.min',
      'spectrum': './vendor/js/spectrum.min',

      /* other libraries */
      'underscore': './vendor/js/underscore-min',
      'chroma': './vendor/js/chroma.min',

      /* THREE.js and plugins */
      'three': './vendor/js/three.min',
      'orbitcontrols': './vendor/js/three.js-plugins/OrbitControls',

      /* SlickGrid */
      'slickcore': './vendor/js/slick.core.min',
      'slickgrid': './vendor/js/slick.grid.min',
      'slickformatters': './vendor/js/slick.editors.min',
      'slickeditors': './vendor/js/slick.formatters.min',

      /* Emperor's objects */
      'model': './js/model',
      'view': './js/view',
      'controller': './js/controller',
      'draw': './js/draw',
      'scene3d': './js/sceneplotview3d',
      'viewcontroller': './js/view-controller',
      'colorviewcontroller': './js/color-view-controller',
      'visibilitycontroller': './js/visibility-controller',
      'color-editor': './js/color-editor',
    },
    /*
       Libraries that are not AMD compatible need shim to declare their
       dependencies.
     */
    'shim': {
      'jquery_drag': {
        'deps': ['jquery', 'jqueryui']
      },
      'chosen': {
        'deps': ['jquery'],
        'exports': 'jQuery.fn.chosen'
      },
      'orbitcontrols': {
        'deps': ['three']
      },
    'slickcore': ['jqueryui'],
    'slickgrid': ['slickcore', 'jquery_drag', 'slickformatters',
                  'slickeditors']
    }
  });

  requirejs(
    ["jquery", "model", "controller"],
    function($, model, EmperorController) {
      var DecompositionModel = model.DecompositionModel;

      var div = $('#emperor-plot');
      var ids = {% raw coords_ids %};
      var coords = {% raw coords %};
      var pct_var = {% raw pct_var %};
      var md_headers = {% raw md_headers%};
      var metadata = {% raw  metadata %};

      var dm;

      function init() {
        // Initialize the DecompositionModel
        dm = new DecompositionModel(name, ids, coords, pct_var,
                                    md_headers, metadata);
        // Initialize the EmperorController
        ec = new EmperorController(dm, 'emperor-plot');
      }

      $(window).resize(function() {
        ec.resize(window.innerWidth * 0.5, window.innerHeight * 0.7);
      });

      function animate() {
        requestAnimationFrame(animate);
        ec.render();
      }

      function rescale() {
        var sv = ec.sceneViews[0];
        //Shrink original points back to regular size and opacity
        for (var i = 0 ; i < ec.sceneViews[0].decViews.scatter.markers.length; i++) {
          var point = sv.decViews.scatter.markers[i];
          point.material.transparent = true;
          point.material.opacity = 0.4;
          point.scale.x = 1;
          point.scale.y = 1;
          point.scale.z = 1;
        }

        //TRIPLE SIZE OF BARCODE POINT
        var sample = sv.scene.getObjectByName($("#barcode-fold").val());
        sample.scale.x = 3;
        sample.scale.y = 3;
        sample.scale.z = 3;
        point.material.opacity = 1;
        sample.material.transparent = false;
      }


      $(document).ready(function(){
        init();
        animate();
        var sv = ec.sceneViews[0];

        $("#barcode-fold").on("change", function () {
          fold_change();
          rescale();
        });

        $("#meta-cat-fold").on("change", function () {
          fold_change();
          cat = $("#meta-cat-fold").val().split("-")[0];
          switch(cat) {
            case 'age':
              cat = 'age_cat';
              break;
            case 'bmi':
              cat = 'bmi_cat';
              break;
            case 'sex':
              cat = 'sex';
              break;
            default:
            cat = 'all';
          }
          ec.colorController.$select.val(cat);
          ec.colorController.$select.trigger("change");
        });


        //HIDE EDITING USING EMPEROR
        $(function(){
          //var barcodes = getParameterByName('barcodes').split(',');
          ec.colorController.$header.hide();
          ec._$tabsList.hide();
          ec.colorController.$select.val('all');
          ec.colorController.$select.trigger("change");

          //CHANGE BG TO WHITE AND AXES TO BLACK
          sv.drawAxesLabelsWithColor('#000000');
          sv.drawAxesWithColor('#000000');
          sv.renderer.setClearColor('#FFFFFF');

          rescale();

        //RECOLOR TO HIGHLIGHT POINTS
          s = sv.decViews.scatter;
          s.setGroupColor(0xFF0000, s.decomp.getPlottableByIDs([$("#barcode-fold").val()]));
        });
      });
  }); // END REQUIRE.JS block

  $(document).ready(function () {
    var ctf = document.getElementById("canvas-bar-fold").getContext("2d");
    barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, 'phylum', 10)
    window.foldBar = new Chart(ctf, {
        type: 'bar',
        data: barChartFoldData,
        barStrokeWidth:0,
        options: {
            legend: {
              display: false
            },
            title:{
                display:true,
                text:"Taxonomic Fold Changes"
            },
            tooltips: {
                mode: 'single',
            },
            responsive: true,
            scales: {
                xAxes: [{
                  ticks: {
                    autoSkip: false
                  }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Log2 Fold Change'
                    }
                }]
            }
        }
    });
    fold_change();
    $("#collapse-fold").on("change", fold_change);
  });
</script>
{% end %}
{% block content %}
<div id="taxa-fold-wrapper" style="width:100%; position: relative;">
    <div id="taxa-fold-controls">
    <table style="width: 70%"><tr><td>
      <h3>Explore a sample in detail</h3>
      Sample:
      <select id="barcode-fold">
    {% for bc in barcodes %}
        <option value="{{bc['barcode']}}">{{bc['barcode']}} - {{bc['sample_date'].strftime('%b %d, %Y')}}</option>
    {% end %}
      </select>
    </td><td>
    <h3>Compare with population averages</h3>
    Select taxa level <a href="" onclick="return false;" title="THIS IS THE TAXA TOOLTIP">?</a>:
    <select id="collapse-fold">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select>
    Category:<select id="meta-cat-fold">
      <option value="">All samples</option>
    {% for meta in meta_cats %}
      <option value="{{meta}}">{{meta}}</option>
    {% end %}
    </select>
    </td></tr>
  </table>
  </div>
  <div style="width: 60%; float:left;">
      <canvas id="canvas-bar-fold"></canvas>
  </div>
  <div style="width: 40%; float:left;"><h4>Alpha Diversity</h4><img src="" id="alpha-div-image" style="vertical-align: middle; width: 100%;"></div>
</div>
<div id="taxa-fold-text" style="position:relative;clear: left;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>
<hr>
  <div id='emperor-plot' class='emperor-space'></div>
{% end %}
