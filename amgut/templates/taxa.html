{%extends sitebase.html%}
{% block head %}
    <script src="/static/vendor/js/Chart.bundle.min.js"></script>
    <script src="/static/vendor/js/chroma.min.js"></script>
    <script src="/static/js/interactive.js"></script>
    <script type="text/javascript">
      var barChartSummaryData = {
        labels: {% raw [b['barcode'] + ' - ' + t for b, t in zip(barcodes, titles)] %},
        rawLabels: null,
        datasets: null,
        rawData: {% raw datasets %},
        metaData: null
      };
      var barChartFoldData = {
        labels: [],
        datasets: [],
        barcodes: {% raw [b['barcode'] for b in barcodes] %},
        titles: {% raw titles %}
      };
      var available_summaries = {% raw available_summaries %};

    window.onload = function() {
    var ctx = document.getElementById("canvas-bar-summary").getContext("2d");
    var ctf = document.getElementById("canvas-bar-fold").getContext("2d");
    // Exploit JSON to make extremely fast deep copy of objects
    barChartSummaryData.metaData = JSON.parse(JSON.stringify(barChartSummaryData.rawData));
    barChartSummaryData.rawLabels = JSON.parse(JSON.stringify(barChartSummaryData.labels));
    barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, 'phylum', 10);
    window.summaryBar = new Chart(ctx, {
        type: 'bar',
        data: barChartSummaryData,
        barStrokeWidth:0,
        options: {
            legend: {
              position: 'top'
            },
            title:{
                display:true,
                text:"Taxonomic Relative Abundances"
            },
            tooltips: {
                mode: 'label', // single if just want one OTU
            },
            responsive: true,
            scales: {
                xAxes: [{
                    stacked: true,
                    showVerticalLines: false
                }],
                yAxes: [{
                    stacked: true,
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Percent abundance'
                    },
                }]
            }
        }
    });

    window.foldBar = new Chart(ctf, {
        type: 'bar',
        data: barChartFoldData,
        barStrokeWidth:0,
        options: {
            legend: {
              display: false
            },
            title:{
                display:true,
                text:"Taxonomic Fold Changes"
            },
            tooltips: {
                mode: 'single',
            },
            responsive: true,
            scales: {
                xAxes: [{
                  ticks: {
                    autoSkip: false
                  }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                      display: true,
                      labelString: 'Log2 Fold Change'
                    }
                }]
            }
        }
    });
    fold_change();
    //fill categories based on site
    buildCats($('#barcode-fold option:selected').data('site'), $('#meta-cat-fold'), false);

    $("#collapse-fold").on("change", fold_change);

    $("#barcode-fold").on("change", function () {
      buildCats($('#barcode-fold option:selected').data('site'), $('#meta-cat-fold'), false);
      fold_change();

    });

    $("#meta-cat-fold").on("change", fold_change);

    $("#canvas-bar-summary").on('click', function(evt){
      var activePoints = window.summaryBar.getElementAtEvent(evt);
      if (activePoints.length > 0 && $("#collapse").val() != "genus") {
        var taxa = activePoints[0]._model.datasetLabel;
        if(taxa == "Other") {
          return;
        }
        var label = activePoints[0]._model.label;
        var prev_level = $("#collapse").val();
        $("#collapse > option:selected").prop("selected", false).next().prop("selected", true);
        barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, $("#collapse").val(), 10, prev_level, taxa);
        window.summaryBar.update();
      }
    });

    $("#collapse").on("change", function () {
      barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, $("#collapse").val(), 10);
      window.summaryBar.update();
    })

    $("#reset-summary").on("click", function () {
      $("#collapse").val('phylum');
      barChartSummaryData.labels = JSON.parse(JSON.stringify(barChartSummaryData.rawLabels));
      barChartSummaryData.metaData = JSON.parse(JSON.stringify(barChartSummaryData.rawData));
      barChartSummaryData.datasets = collapse(barChartSummaryData.metaData, 'phylum', 10);
      //re-add all remove links
      $.each($("td"), function( i, val ) { val.remove(); });
      for(var i=0;i<barChartSummaryData.labels.length;i++) {
        var rem = $('<td><a href="#" onclick="remove_sample(\'' + barChartSummaryData.labels[i] + '\'); return false;">Remove</a></td>');
        $("#remove-row").append(rem);
      }
      window.summaryBar.update();
    });
    $("#meta-site").on("change", function (evt) {
      var site = $("#meta-site").val();
      var catDropdown = $("#meta-cat");
      buildCats(site, catDropdown);
    });
    $("#meta-cat").on("change", function (evt) {
      if($("#meta-cat").val() == "") {
        $("#add-sumary-cat").prop("disabled", true);
      } else {
        $("#add-sumary-cat").prop("disabled", false);;
      }
    });
    $("#meta-cat").prop("disabled", true);
    $("#add-sumary-cat").prop("disabled", true);
};
    </script>
    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
{% end%}
{% block content %}
<div id="taxa-summary-wrapper" style="width:100%; position: relative;">
<div id="taxa-summary-controls">
  <h3>Relative taxonomy</h3>
    Select taxa level <a href="" onclick="return false;" title="THIS IS THE TAXA TOOLTIP">?</a>: 
    <select id="collapse">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select> <button id="reset-summary">Reset Graph</button><br/>
    Add
    Site: <select id="meta-site">
      <option value=""></option>
      <option value="stool">Stool</option>
      <option value="skin">Skin</option>
      <option value="oral">Oral</option>
    </select> 
    Category:<select id="meta-cat">
      <option value=""></option>
    </select><button onclick="add_metadata_barchart()" id="add-sumary-cat">Add</button>
  </div>
  <div style="width: 100%;">
      <canvas id="canvas-bar-summary"></canvas>
      <table style="width:94%; float:right;" id="remove-table"><tr id="remove-row">
    {% for b, t in zip(barcodes, titles) %}
      <td><a href="#" onclick="remove_sample('{% raw b['barcode'] + ' - ' + t %}'); return false;">Remove</a></td>
    {% end %}
      </tr></table>
  </div>
</div>
<div id="taxa-summary-text" style="position:relative;clear: right; padding:5px">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>
<hr>
<div id="taxa-fold-wrapper" style="width:100%; position: relative;">
    <div id="taxa-fold-controls">
    <table style="width: 70%"><tr><td>
      <h3>Explore a sample in detail</h3>
      Sample:
      <select id="barcode-fold">
    {% for bc in barcodes %}
        <option value="{{bc['barcode']}}" data-site="{{ bc['site_sampled'].lower() if bc['site_sampled'] is not None else bc['environment_sampled'].lower() }}">{{bc['barcode']}} - {{bc['sample_date'].strftime('%b %d, %Y')}}</option>
    {% end %}
      </select>
    </td><td>
    <h3>Compare with population averages</h3>
    Select taxa level <a href="" onclick="return false;" title="THIS IS THE TAXA TOOLTIP">?</a>:
    <select id="collapse-fold">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select>
    Category:<select id="meta-cat-fold">
      <option value="">All samples</option>
    </select>
    </td></tr>
  </table>
  </div>
  <div style="width: 60%; float:left;">
      <canvas id="canvas-bar-fold"></canvas>
  </div>
  <div style="width: 40%; float:left;"><h4>Alpha Diversity</h4><img src="" id="alpha-div-image" style="vertical-align: middle; width: 100%;"></div>
</div>
<div id="taxa-fold-text" style="position:relative;clear: left;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>
{% end %}
