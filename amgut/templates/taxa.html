{%extends sitebase.html%}
{% block head %}
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/static/vendor/js/Chart.bundle.min.js"></script>
    <script src="/static/vendor/js/chroma.min.js"></script>
    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
{% end%}
{% block content %}
<div id="taxa-summary-wrapper" style="width:100%; position: relative;">
<div id="taxa-summary-controls">
  <h3>Relative taxonomy</h3>
    Select taxa level: 
    <select id="collapse">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select><br/>
    Add
    Site: <select id="meta_site">
      <option value=""></option>
      <option value="stool">Stool</option>
    </select> 
    Category:<select id="meta_cat">
      <option value=""></option>
    {% for meta in meta_cats %}
      <option value="{{meta}}">{{meta}}</option>
    {% end %}
    </select><button onclick="add_metadata_barchart()">Add</button>
  </div>
  <div style="width: 100%;">
      <canvas id="canvas-bar-summary"></canvas>
  </div>
</div>
<div id="taxa-summary-text" style="position:relative;clear: left;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>
<div id="taxa-fold-wrapper" style="width:100%; position: relative;">
  <h3>Explore a sample in detail</h3>
  <div id="taxa-fold-controls">
    <p>Sample: 
    <select id="barcode-fold">
      <option value=""></option>
  {% for bc, t in barcodes %}
      <option value="{{bc}}">{{t.strftime('%b %d, %Y')}}</option>
  {% end %}
    </select><p>
    Compare with population averages<br/>
    Select taxa level:
    <select id="collapse-fold">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select>
    Category:<select id="meta_cat_fold">
      <option value=""></option>
    {% for meta in meta_cats %}
      <option value="{{meta}}">{{meta}}</option>
    {% end %}
    </select> <button onclick="fold_change($('#collapse-fold').val())">Compare</button>
  </div>
  <div style="width: 60%; float:left;">
      <canvas id="canvas-bar-fold"></canvas>
  </div>
  <div style="width: 40%; float:left;"><img src="" id="alpha-div-image" style="vertical-align: middle; width: 100%;"></div>
</div>
<div id="taxa-fold-text" style="position:relative;clear: left;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>
<script>
  var phylum_colors = {
    'Bacteroidetes': ['pink', 'darkred'],
    'Firmicutes': ['#FFD27F', '#BE5E00'],
    'Actinobacteria': ['lightgreen', 'darkgreen'],
    'Proteobacteria': ['lightblue', 'darkblue'],
    'TM7': ['lightgrey', 'black']
  };

  function group(list, prop) {
    var grouped = {};
    for(var i=0;i<list.length;i++) {
      var key = list[i][prop];
      grouped[key] = grouped[key] || [];
      grouped[key].push(list[i]);
    }
    return grouped;
  }

  function getAvg(list) {
    return list.reduce(function (x, y) {
      return x + y;
    }) / list.length;
  }

  function sum_arrays(ar1, ar2) {
    var sum = [];
    if (ar1.length == ar2.length) {
        for (var i=0; i<ar1.length;i++) {
            sum.push(ar1[i] + ar2[i]);
        }
    }
    else {
      throw "Arrays unequal length: " + ar1.length + "  " + ar2.length;
    }
    return sum;
  }

  function find_otu(list, otu, level) {
    var lvl = level || 'label';
    function inner(element, index, array) {
      if(element[lvl] == this) { return true; }
      return false;
    }
    return list.findIndex(inner, otu);
  }

  function filter_sites(list, sites) {

  }

  function collapse(dataset, level, max, prev_level, focus, sites) {
    var max_otus = max || 8;
    var focus_taxa = focus || null;
    var filter_to = sites || null;
    var groups = group(dataset, level);
    var collapsed = {};
    var summaries = [];
    for(var g in groups) {
      if(focus !== null && groups[g][0][prev_level] != focus_taxa) { continue; }
      var otu = { label: g,  data: groups[g][0].data, phylum: groups[g][0].phylum};
      // Collapse the OTUs found in the group into a single
      for(var i=1;i<groups[g].length;i++) {
        otu.data = sum_arrays(otu.data, groups[g][i].data);
      }
      // Round to four decimals
      for(var i=0;i<otu.data.length;i++) { otu.data[i] =  Number(otu.data[i].toFixed(4)); }
      if(g === '') { otu.label = 'Unspecified'; }

      collapsed[g] = otu;
      summaries.push([g, getAvg(otu.data)]);
    }

    //collapse further to max number of OTUs and color properly
    var phyla_counts = {};
    var further_collapsed = [];
    sorted = summaries.sort(function(a, b) { return b[1] - a[1]; });
    var loop = sorted.length;
    if(loop > max) { loop = max; }
    for(var i=0;i<loop;i++) {
      further_collapsed.push(collapsed[sorted[i][0]]);
      phyla_counts[collapsed[sorted[i][0]].phylum] = phyla_counts[collapsed[sorted[i][0]].phylum] + 1 || 1;
    }
    // Recolor based on phyla counts, so each phyla is a different color, and those within phyla a different shade
    phyla_colors = {};
    for(phyla in phyla_counts) {
      if(phyla_counts[phyla] == 1) {
        //Get colors for known phyla or black
        var color = phylum_colors[phyla]  || ['', '#000000'];
        phyla_colors[phyla] = [chroma(color[1]).hex()];
      } else {
        //Get colors for known phyla or white to black
        if(phylum_colors[phyla]) {
        phyla_colors[phyla] = chroma.scale([phylum_colors[phyla][0], phylum_colors[phyla][1]]).colors(phyla_counts[phyla]);
        } else {
          phyla_colors[phyla] = chroma.scale(['#FFFFFF', '#000000']).colors(phyla_counts[phyla]);
        }
      }
    }
    for(var i=0;i<further_collapsed.length;i++) {
      var ph = further_collapsed[i].phylum;
      var color = chroma(phyla_colors[ph].pop()).css();
      further_collapsed[i].backgroundColor = color;
    }

    if(sorted.length > max) {
      // reate the OTHER category for the rest of the OTUs
      var other = { label: 'Other',  data:collapsed[sorted[loop][0]].data, backgroundColor: 'rgba(180,180,180)' };
      for(var i=loop+1;i<sorted.length;i++){
        other.data = sum_arrays(other.data, collapsed[sorted[i][0]].data);
      }
      for(var i=0;i<other.data.length;i++) { other.data[i] =  Number(other.data[i].toFixed(4)); }
      further_collapsed.push(other);
    }
    if(filter_to !== null) {
      further_collapsed = filter_sites(further_collapsed, filter_to)
    }

    return further_collapsed;
  }

  function fold_change(collapsed_level) {
    var level = collapsed_level || 'phylum';
    var category = $("#meta_cat_fold").val();
    var barcode = $("#barcode-fold").val();
    //Don't do anything if they submit on empty value
    if(category === "" || barcode === "") { return; }

    $.get('/interactive/metadata/', {category: category, barcode: barcode})
      .done(function (data) {
        var fold_changes = [];
        var data_pos = barChartFoldData.barcodes.findIndex(y => Object.is(barcode, y));
        var data_len = barChartFoldData.rawData[0].data.length;
        var collapsed = collapse(barChartFoldData.rawData, level, 10000);
        var data_collapsed = collapse(data, level, 10000);
        for(var i=0;i<data_collapsed.length;i++) {
          var otu = data_collapsed[i];
          var pos = find_otu(collapsed, otu.label);
          //sanity checks to make sure we aren't doing something dumb
          if(pos === -1 || otu.data === 0) { continue; }
          var folds = [];
          var sample_data = barChartFoldData.rawData[pos].data;

          //Compute the fold changes, making them negative when needed
          var val = sample_data[data_pos]/otu.data;
          if(val === 0) { continue; }
          folds.push(Math.log2(val));
          fold_changes.push([otu.label, folds, getAvg(folds), otu.backgroundColor]);
        }
        //Sort by the average and build the data information
        var sorted = fold_changes.sort(function(a, b) { return b[2] - a[2]; });
        graph_data = [];
        for(var i=0;i<sorted.length;i++) {
          // Stop showing things that are less than 0.5 fold change
          //if(-0.5 > sorted[i][2] < 0.5) { continue; }
          graph_data.push({
            label: sorted[i][0],
            data: sorted[i][1],
            backgroundColor: sorted[i][3]
          });
        }
        barChartFoldData.labels = [barChartFoldData.titles[data_pos]];
        barChartFoldData.datasets = graph_data;
        window.foldBar.update();

        $("#alpha-div-image").attr("src", "/interactive/alpha_div/" + barcode + "?category=" + category);
      })
      .fail(function () {
        alert('FAIL!');
      });
  }

  function add_metadata_barchart() {
    var category = $("#meta_cat").val();
    var site = $("#meta_site").val();
    //Don't do anything if they submit on empty value
    if(category.length == 0 || site.length == 0) { return; }
    var title = category + "  " + site;
    //column already in graph, so don't add again
    if(barChartSummaryData.labels.indexOf(title) != -1) { return; }

    $.get('/interactive/metadata/', {category: $("#meta_cat").val(), site: $("#meta_site").val()})
      .done(function (data) {
        for(var i=0;i<data.length;i++) {
          var otu = data[i];
          var existing = find_otu(barChartSummaryData.rawData, otu.full, 'full');
          if(existing == -1) {
            //add the OTU as zero for all existing labels, then add value from meta_cat
            var val = otu.data[0];
            otu.data = new Array(barChartSummaryData.labels.length+1).join('0').split('').map(parseFloat);
            otu.data.push(val);
            barChartSummaryData.rawData.push(otu);
          } else {
            ///OTU already exists, so add to end of existing one
            raw_data[existing].data.push(val);
          }
        }
        //Loop over raw data and add 0 to any OTUs that are in raw data but not in meta_cat
        var full_len = barChartSummaryData.labels.length + 1;
        for(var i=0;i<barChartSummaryData.rawData.length;i++) {
          if(barChartSummaryData.rawData[i].data.length < full_len) { barChartSummaryData.rawData[i].data.push(0.0); }
        }
        barChartSummaryData.labels.push(title);
        barChartSummaryData.datasets = collapse(barChartSummaryData.rawData, $("#collapse").val(), 10);
        window.summaryBar.update();
      })
      .fail(function () {
        alert ('FAIL!');
      });
  }

  var barChartSummaryData = {
      labels: {% raw titles %},
      datasets: [],
      rawData: {% raw datasets %}
  };
  var barChartFoldData = {
      labels: [],
      datasets: [],
      barcodes: {% raw [b[0] for b in barcodes] %},
      titles: {% raw titles %},
      rawData: {% raw datasets %}
  };
  window.onload = function() {
      var ctx = document.getElementById("canvas-bar-summary").getContext("2d");
      var ctf = document.getElementById("canvas-bar-fold").getContext("2d");
      barChartSummaryData.datasets = collapse(barChartSummaryData.rawData, 'phylum', 10)
      window.summaryBar = new Chart(ctx, {
          type: 'bar',
          data: barChartSummaryData,
          barStrokeWidth:0,
          options: {
              legend: {
                position: 'bottom'
              },
              title:{
                  display:true,
                  text:"Taxonomic Relative Abundances"
              },
              tooltips: {
                  mode: 'label', // single if just want one OTU
              },
              responsive: true,
              scales: {
                  xAxes: [{
                      stacked: true,
                      showVerticalLines: false
                  }],
                  yAxes: [{
                      stacked: true,
                      display: true,
                      scaleLabel: {
                        display: true,
                        labelString: 'Percent abundance'
                      }
                  }]
              }
          }
      });
      window.foldBar = new Chart(ctf, {
          type: 'bar',
          data: barChartFoldData,
          barStrokeWidth:0,
          options: {
              legend: {
                position: 'bottom'
              },
              title:{
                  display:true,
                  text:"Taxonomic Fold Changes"
              },
              tooltips: {
                  mode: 'single',
              },
              responsive: true,
              scales: {
                  xAxes: [{
                      showVerticalLines: false
                  }],
                  yAxes: [{
                      display: true,
                      scaleLabel: {
                        display: true,
                        labelString: 'Log_2 Fold Change'
                      }
                  }]
              }
          }
      });

      $("#canvas-bar-summary").on('click', function(evt){
        var activePoints = window.summaryBar.getElementAtEvent(evt);
        if (activePoints.length > 0 && $("#collapse").val() != "genus") {
          var taxa = activePoints[0]._model.datasetLabel;
          var label = activePoints[0]._model.label;
          var prev_level = $("#collapse").val();
          $("#collapse > option:selected")
              .prop("selected", false)
              .next()
              .prop("selected", true);
          barChartSummaryData.datasets = collapse(barChartSummaryData.rawData, $("#collapse").val(), 10, prev_level, taxa);
          window.summaryBar.update();
        }
      });

      $("#collapse").on("change", function () {
        barChartSummaryData.datasets = collapse(barChartSummaryData.rawData, $("#collapse").val(), 10);
        window.summaryBar.update();
      })
  };
</script>
{% end %}
