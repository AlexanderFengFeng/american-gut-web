{%extends sitebase.html%}
{% block head %}
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/static/vendor/js/Chart.bundle.min.js"></script>
    <script src="/static/vendor/js/chroma.min.js"></script>
    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
{% end%}
{% block content %}
<div id="taxa-graph-wrapper" style="width:100%; position: relative;">
  <div style="width: 80%; float: left">
      <canvas id="canvas"></canvas>
  </div>
  <div id="taxa-graph-controls" style="width: 19%; float:left; align-text: left; align-content: left; padding-top: 20px">
  <h3>Interact with Data</h3>
    <p>Select taxa level: 
    <select id="collapse">
      <option value="phylum">Phylum</option>
      <option value="class">Class</option>
      <option value="order">Order</option>
      <option value="family">Family</option>
      <option value="genus">Genus</option>
    </select></p>
    <p>Add metadata<br/>
    Site: <select id="meta_site">
      <option value=""></option>
      <option value="fecal">fecal</option>
    </select>
    <br/>
    Category:<select id="meta_cat">
      <option value=""></option>
    {% for meta in meta_cats %}
      <option value="{{meta}}">{{meta}}</option>
    {% end %}
    </select><button onclick="add_metadata_barchart()">Add</button></p>
  </div>
</div>
<div id="taxa-graph-text" style="position:relative;clear: left;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus finibus dolor in lacinia. In ultricies aliquam ipsum in convallis. Aenean pellentesque egestas malesuada. Nam finibus nisi ut imperdiet tincidunt. Praesent a nibh a nisi ultrices pretium. Nullam ornare auctor enim ullamcorper aliquet. Integer tempus fringilla erat, accumsan convallis diam aliquet aliquam. Integer a tristique nunc. Morbi lobortis nec est sed tincidunt.
</div>

<script>
  var rawData = {% raw datasets %};
  var phylum_colors = {
    'Bacteroidetes': ['pink', 'darkred'],
    'Firmicutes': ['#FFD27F', '#BE5E00'],
    'Actinobacteria': ['lightgreen', 'darkgreen'],
    'Proteobacteria': ['lightblue', 'darkblue'],
    'TM7': ['lightgrey', 'black']
  };

  function group(list, prop) {
    var grouped = {};
    for(var i=0;i<list.length;i++) {
      var key = list[i][prop];
      grouped[key] = grouped[key] || [];
      grouped[key].push(list[i]);
    }
    return grouped;
  }

  function getAvg(list) {
    return list.reduce(function (x, y) {
      return x + y;
    }) / list.length;
  }

  function sum_arrays(ar1, ar2) {
    var sum = [];
    if (ar1.length == ar2.length) {
        for (var i=0; i<ar1.length;i++) {
            sum.push(ar1[i] + ar2[i]);
        }
    }
    else {
      throw "Arrays unequal length: " + ar1.length + "  " + ar2.length;
    }
    return sum;
  }

  function collapse(level, max, prev_level, focus) {
    var max_otus = max || 8;
    var focus_taxa = focus || null;
    var groups = group(rawData, level);
    var collapsed = {};
    var summaries = [];
    for(var g in groups) {
      if(focus !== null && groups[g][0][prev_level] != focus_taxa) { continue; }
      var otu = { label: g,  data: groups[g][0].data, phylum: groups[g][0].phylum};
      // Collapse the OTUs found in the group into a single
      for(var i=1;i<groups[g].length;i++) {
        otu.data = sum_arrays(otu.data, groups[g][i].data);
      }
      // Round to four decimals
      for(var i=0;i<otu.data.length;i++) { otu.data[i] =  Number(otu.data[i].toFixed(4)); }
      if(g === '') { otu.label = 'Unspecified'; }

      collapsed[g] = otu;
      summaries.push([g, getAvg(otu.data)]);
    }

    //collapse further to max number of OTUs and color properly
    var phyla_counts = {};
    var further_collapsed = [];
    sorted = summaries.sort(function(a, b) { return b[1] - a[1]; });
    var loop = sorted.length;
    if(loop > max) { loop = max; }
    for(var i=0;i<loop;i++) {
      further_collapsed.push(collapsed[sorted[i][0]]);
      phyla_counts[collapsed[sorted[i][0]].phylum] = phyla_counts[collapsed[sorted[i][0]].phylum] + 1 || 1;
    }
    // Recolor based on phyla counts, so each phyla is a different color, and those within phyla a different shade
    phyla_colors = {};
    for(phyla in phyla_counts) {
      if(phyla_counts[phyla] == 1) {
        //Get colors for known phyla or black
        var color = phylum_colors[phyla]  || ['', '#000000'];
        phyla_colors[phyla] = [chroma(color[1]).hex()];
      } else {
        //Get colors for known phyla or white to black
        if(phylum_colors[phyla]) {
        phyla_colors[phyla] = chroma.scale([phylum_colors[phyla][0], phylum_colors[phyla][1]]).colors(phyla_counts[phyla]);
        } else {
          phyla_colors[phyla] = chroma.scale(['#FFFFFF', '#000000']).colors(phyla_counts[phyla]);
        }
      }
    }
    for(var i=0;i<further_collapsed.length;i++) {
      var ph = further_collapsed[i].phylum;
      var color = chroma(phyla_colors[ph].pop()).css();
      further_collapsed[i].backgroundColor = color;
    }

    if(sorted.length <= max) {
      //the list of OTUs is equal to or smaller than max, so no need to collapse "Other" category
      return further_collapsed;
    }

    var other = { label: 'Other',  data:collapsed[sorted[loop][0]].data, backgroundColor: 'rgba(180,180,180)' };
    for(var i=loop+1;i<sorted.length;i++){
      other.data = sum_arrays(other.data, collapsed[sorted[i][0]].data);
    }
    for(var i=0;i<other.data.length;i++) { other.data[i] =  Number(other.data[i].toFixed(4)); }
    further_collapsed.push(other);

    return further_collapsed;
  }

  function add_metadata_barchart() {
    function find_otu(element, index, array) {
      if(element.full == this) { return true; }
      return false;
    }
    var category = $("#meta_cat").val();
    var site = $("#meta_site").val();
    //Don't do anything if they submit on empty value
    if(category.length == 0 || site.length == 0) { return; }
    var title = category + "  " + site;
    //column already in graph, so don't add again
    if(barChartData.labels.indexOf(title) != -1) { return; }

    $.get('/interactive/metadata/', {category: $("#meta_cat").val(), site: $("#meta_site").val()})
      .done(function (data) {
        for(var i=0;i<data.length;i++) {
          var otu = data[i];
          var existing = rawData.findIndex(find_otu, category);
          if(existing == -1) {
            //add the OTU as zero for all existing labels, then add value from meta_cat
            var val = otu.data;
            otu.data = new Array(barChartData.labels.length+1).join('0').split('').map(parseFloat);
            otu.data.push(val);
            rawData.push(otu);
          } else {
            ///OTU already exists, so add to end of existing one
            raw_data[existing].data.push(val);
          }
        }
        //Loop over raw data and add 0 to any OTUs that are in raw data but not in meta_cat
        var full_len = barChartData.labels.length + 1;
        for(var i=0;i<rawData.length;i++) {
          if(rawData[i].data.length < full_len) { rawData[i].data.push(0.0); }
        }
        barChartData.labels.push(title);
        barChartData.datasets = collapse($("#collapse").val(), 10);
        window.myBar.update();
      })
      .fail(function () {
        alert ('FAIL!');
      });
  }

  var barChartData = {
      labels: {% raw barcodes %},
      datasets: collapse('phylum', 10)
  };
  window.onload = function() {
      var ctx = document.getElementById("canvas").getContext("2d");
      window.myBar = new Chart(ctx, {
          type: 'bar',
          data: barChartData,
          barStrokeWidth:0,
          options: {
              legend: {
                position: 'bottom'
              },
              title:{
                  display:true,
                  text:"Taxonomic Relative Abundances"
              },
              tooltips: {
                  mode: 'label', // single if just want one OTU
              },
              responsive: true,
              scales: {
                  xAxes: [{
                      stacked: true,
                      showVerticalLines: false
                  }],
                  yAxes: [{
                      stacked: true,
                      display: true,
                      scaleLabel: {
                        display: true,
                        labelString: 'Percent abundance'
                      }
                  }]
              }
          }
      });

      $("#canvas").on('click', function(evt){
        var activePoints = window.myBar.getElementAtEvent(evt);
        if (activePoints.length > 0 && $("#collapse").val() != "genus") {
          var taxa = activePoints[0]._model.datasetLabel;
          var label = activePoints[0]._model.label;
          var prev_level = $("#collapse").val();
          $("#collapse > option:selected")
              .prop("selected", false)
              .next()
              .prop("selected", true);
          barChartData.datasets = collapse($("#collapse").val(), 10, prev_level, taxa);
          window.myBar.update();
        }
      });

      $("#collapse").on("change", function () {
        barChartData.datasets = collapse($("#collapse").val(), 10);
        window.myBar.update();
      })
  };
</script>
{% end %}
