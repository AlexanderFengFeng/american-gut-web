<!doctype html>
<html>

<head>
    <title>Stacked Bar Chart</title>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/static/vendor/js/Chart.bundle.min.js"></script>
    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    </style>
</head>

<body>
    <select id="collapse">
        <option value="phylum">Phylum</option>
        <option value="class">Class</option>
        <option value="order">Order</option>
        <option value="family">Family</option>
        <option value="genus">Genus</option>
    </select>
    <div style="width: 75%; float: left">
        <canvas id="canvas"></canvas>
    </div>
    <div id="legend"style="width: 24%; float:left"></div>
    <script>
      var rawData = {% raw datasets %};

      function group(list, prop) {
        var grouped = {};
        for(var i=0;i<list.length;i++) {
          var key = list[i][prop];
          grouped[key] = grouped[key] || [];
          grouped[key].push(list[i]);
        }
        return grouped;
      }

      function sum_arrays(ar1, ar2) {
        var sum = [];
        if (ar1.length == ar2.length) {
            for (var i=0; i<ar1.length;i++) {
                sum.push(ar1[i] + ar2[i]);
            }
        }
        return sum;
      }

      function randomColorFactor() { return "rgba(" + Math.round(Math.random() * 255) + "," + Math.round(Math.random() * 255)+ "," + Math.round(Math.random() * 255) + ",.7)"; };
      function collapse(level) {
        var groups = group(rawData, level);
        var collapsed = [];
        for(g in groups) {
          var otu = { label: g,  data:groups[g][0].data, backgroundColor: randomColorFactor() };
          for(var i=1;i<groups[g].length;i++) {
            otu.data = sum_arrays(otu.data, groups[g][i].data);
          }
          console.log(otu);
          collapsed.push(otu);
        }
        return collapsed;
      }

      var barChartData = {
          labels: {% raw barcodes %},
          datasets: collapse('phylum')
      };
      window.onload = function() {
          Chart.defaults.global.legend.display = false;
          var ctx = document.getElementById("canvas").getContext("2d");
          window.myBar = new Chart(ctx, {
              type: 'bar',
              data: barChartData,
              options: {
                  title:{
                      display:true,
                      text:"Chart.js Bar Chart - Stacked"
                  },
                  tooltips: {
                      mode: 'label'
                  },
                  responsive: true,
                  scales: {
                      xAxes: [{
                          stacked: true,
                      }],
                      yAxes: [{
                          stacked: true,
                          labelstring: 'Percent abundance'
                      }]
                  }
              }
          });
          document.getElementById("legend").innerHTML = window.myBar.generateLegend();

          $("#collapse").on("change", function () {
            barChartData.datasets = collapse($("#collapse").val());
            window.myBar.update();
            document.getElementById("legend").innerHTML = window.myBar.generateLegend();
          })
      };
    </script>
</body>

</html>
